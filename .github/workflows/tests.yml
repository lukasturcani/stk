name: Tests

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

jobs:
  ruff:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/lukasturcani/stk-test-environment

    steps:
      - name: Git checkout
        uses: actions/checkout@v3

      - name: Install stk
        run: |
          . /deps/venv/bin/activate
          pip install --no-deps -e .

      - name: Run ruff
        run: |
          . /deps/venv/bin/activate
          ruff .

  mypy:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/lukasturcani/stk-test-environment

    steps:
      - name: Git checkout
        uses: actions/checkout@v3

      - name: Install stk
        run: |
          . /deps/venv/bin/activate
          pip install --no-deps -e .

      - name: Run mypy
        run: |
          . /deps/venv/bin/activate
          mypy src

  black:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/lukasturcani/stk-test-environment

    steps:
      - name: Git checkout
        uses: actions/checkout@v3

      - name: Install stk
        run: |
          . /deps/venv/bin/activate
          pip install --no-deps -e .

      - name: Run black
        run: |
          . /deps/venv/bin/activate
          black --check .

  pytest-stable-linux:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/lukasturcani/stk-test-environment

    services:
      MongoDB:
        image: mongo

    steps:
      - name: Git checkout
        uses: actions/checkout@v3

      - name: Install stk
        run: |
          . /deps/venv/bin/activate
          pip install --no-deps -e .

      - name: Run pytest
        run: |
          . /deps/venv/bin/activate
          pytest --mongodb_uri='mongodb://MongoDB:27017/'

  doctest:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/lukasturcani/stk-test-environment

    services:
      MongoDB:
        image: mongo

    steps:
      - name: Git checkout
        uses: actions/checkout@v3

      - name: Install stk
        run: |
          . /deps/venv/bin/activate
          pip install --no-deps -e .

      - name: Run doctest
        run: |
          . /deps/venv/bin/activate
          MONGODB_URI='mongodb://MongoDB:27017/' make -C docs doctest

  basic-ea:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/lukasturcani/stk-test-environment

    services:
      MongoDB:
        image: mongo

    steps:
      - name: Git checkout
        uses: actions/checkout@v3

      - name: Install stk
        run: |
          . /deps/venv/bin/activate
          pip install --no-deps -e .

      - name: Install dependencies
        run: git clone https://github.com/lukasturcani/basic_ea
          --depth 1

      - name: Run the EA
        run: >
          . /deps/venv/bin/activate

          python basic_ea/basic_ea.py
          --mongodb_uri mongodb://MongoDB:27017

      - name: Upload fitness plot
        uses: actions/upload-artifact@v2
        with:
          name: basic-ea-fitness-plot
          path: fitness_progress.png

      - name: Upload rotatable bonds plot
        uses: actions/upload-artifact@v2
        with:
          name: basic-ea-rotatable-bonds-plot
          path: rotatable_bonds_progress.png

  intermediate-ea:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/lukasturcani/stk-test-environment

    services:
      MongoDB:
        image: mongo

    steps:
      - name: Git checkout
        uses: actions/checkout@v3

      - name: Install stk
        run: |
          . /deps/venv/bin/activate
          pip install --no-deps -e .

      - name: Install dependencies
        run: git clone
          https://github.com/lukasturcani/intermediate_ea
          --depth 1

      - name: Run the EA
        run: >
          . /deps/venv/bin/activate

          python intermediate_ea/intermediate_ea.py
          --mongodb_uri mongodb://MongoDB:27017

      - name: Upload fitness plot
        uses: actions/upload-artifact@v2
        with:
          name: intermediate-ea-fitness-plot
          path: fitness_progress.png

      - name: Upload rotatable bonds plot
        uses: actions/upload-artifact@v2
        with:
          name: intermediate-ea-rotatable-bonds-plot
          path: rotatable_bonds_progress.png
